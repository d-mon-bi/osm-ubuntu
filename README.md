# osm-ubuntu
## Description
This repo contains the manifests required to install and execute an Open Street Map instance on a Ubuntu Vagrant running on VirtualBox, using puppet. 
For this purpose, a Vagrant box running ubuntu 14.04 64bit with puppet preinstalled will be used.
OSM will be accessible by pointing the host browser to http://localhost:8888

## Prerequisites

To be able to execute this manifest, you'll need to install in your host:

[Vagrant](http://www.vagrantup.com)

[Virtualbox](http://www.virtualbox.org)

A git client:
* [Git](https://git-scm.com/)
* [GitHub Desktop](https://desktop.github.com)

## Execution instructions

### Initialize virtual machine in vagrant
Fire up a shell:

Run:
```
vagrant init puppetlabs/ubuntu-14.04-64-puppet;
modify the .vagrantfile: add:
config.vm.network "forwarded_port", host_ip: 127.0.0.1,  guest: 8888, host: 8888
vagrant up --provider virtualbox
```

This will bring up the Vagrant box, running under VirtualBox. You should then be able to ssh to the box by running:

```
vagrant ssh
```
	

#### If running under Windows
Since windows does not include an SSH client (As of 1/18/2016``` Microsoft plans on including an ssh client in a future version), you'll need to also install putty (www.putty.org) or another ssh client. An ssh client is included with github desktop for windows.

If you're using putty, you'll need to import the private key generated by vagrant:

1. Fire up puttygen.
2. In puttygen, import %userprofile%\.vagrant.d\insecure_private_key
3. Export key to ppk format to a known location (the same location works just as well)
4. Fire up putty
5. Load/create a connection (By default, Vagrant points to 127.0.0.1:2222)
6. Under connection/data/auto-login, ensure the username = vagrant
7. Under connection/ssh/auth: browse for newly minted ppk key for authentication.	

### Clone the repository

Since this puppet manifest will be executed without a puppet master, puppet can't access a git repository. Therefore, the repo must manually be pulled to the virtual machine.

There are two ways to accomplish this.

#### a. Copy the repository to the default vagrant shared folder
Vagrant automatically creates a shared folder that is mounted within the virtual machine. This is usually located in the <vagrantbin>/.vagrant folder on the gost. So navigate to that folder and run:

```
git clone https://github.com/d-mon-bi/osm-ubuntu
```

This will copy all necessary files to the shared folder, and will be visible within the vagrant box.

#### b. Clone the repository within the vm box. (Not prefered)

You can also clone the repo itself within the vagrant box. This is not preferred, as git is not installed on the vagrant box, and would require you to manually install it first. The puppet manifest will install git as part of the installation. If you prefer to go this route:

1. ssh into the vagrant box
2. Run:
```
sudo apt-get update
sudo apt-get install git
git clone https://github.com/d-mon-bi/osm-ubuntu
```

### Execute the puppet manifest

#### Give the vagrant user permissions
Since puppet will be run manually, and not using the puppet agent, it will be executed with the vagrant user, which belongs to the vagrant group. Therefore, this group must be exempted from path and pwd requirements. To do so: 
1. Run:

```
sudo visudo
```

2. Add a line in the Defaults section that says:
```
Defaults	exempt_group=vagrant
```

3. Close and save the file.

#### Set the environment variable for the puppet manifest location
For simplicity's sake, create an environment variable that points to the location where the puppet repo was cloned to, either the host shared folder or the cloned location.

```
export PUPPET_REPO=<locationOfThePuppetRepo>
```

#### Run the puppet manifest
```
sudo puppet apply --modulepath=$PUPPET_REPO/modules $PUPPET_REPO/init.pp
```
#### Bring up the rails server

This script will download and install the osm server on /home/vagrant/openstreetmap-website/. Navigate to the folder and execute

```
bundle exec rails server
```

## TODO list
* Install RVM
RVM is still causing an issue with the OSM dependencies. Need to investigate further
* Move OSM to a standard location
Currently, it installs in /home/vagrant/. Another location, such as /var/www would be more appropriate
* Validate if OSM is already installed/completed
Currently, if you rerun manifest, OSM will be reinstalled, every time
* Host OSM as a daemon
Currently, OSM needs to be started by executing bundle exec rails server. This should be hosted automatically as a daemon.


